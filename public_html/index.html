<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Keyword Search</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha256-pS96pU17yq+gVu4KBQJi38VpSuKN7otMrDQprzf/DWY=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        body {max-width:960px; margin:20px auto;}
        h1, h2 {text-align:center;}
        h1 {font-size:3rem;}
        h2 {font-size:1.5rem;}
        input {display:block; font-size:3rem; margin:0 auto; text-align:center; width:75%;}
        .card {cursor:pointer; margin-top:20px;}
        .card#selected {background-color:#398ee7; color:#fff;}
        .card#selected a {color:#fff;}
    </style>
</head>
<body onkeydown="keyListener(event)">
    <h1>Keyword-based Search</h1>
    <h2>Created by <a href="https://www.bh96.uk/">Benjamin Howe</a> and <a href="https://github.com/emwebb">Ethen Webb</a></h2>
    <input type="text" id="searchbox" oninput="updateResults()">
    <div id="results">
    </div>
    <script>
        function jsonToCard(json) {
            var cardDiv = document.createElement("div");
            var cardBody = document.createElement("div");
            cardDiv.classList.add("card");
            cardBody.classList.add("card-body");
            cardBody.setAttribute("data-url", json.result.url);
            cardBody.setAttribute("onclick", "window.location.assign(this.getAttribute('data-url'))");

            var title = json.result.title || toTitleCase(json.keyword);
            cardBody.innerHTML = "<strong>" + title + "</strong> (keyword <em>" + json.keyword + "</em>)";

            cardDiv.appendChild(cardBody);
            return cardDiv;
        }

        function keyListener(event) {
            switch (event.code) {
                case "ArrowDown":
                    try {
                        var newSelected = document.getElementById("selected").nextSibling;
                        if (newSelected != null) {
                            document.getElementById("selected").id = "";
                            newSelected.id = "selected";
                        }
                    } catch (e) {} // if no card is selected or there is no next card, do nothing
                    break;

                case "ArrowUp":
                    try {
                        var newSelected = document.getElementById("selected").previousSibling;
                        if (newSelected != null) {
                            document.getElementById("selected").id = "";
                            newSelected.id = "selected";
                        }
                    } catch (e) {} // if no card is selected or there is no previous card, do nothing
                    break;

                case "Enter":
                    try {
                        window.location.assign(document.getElementById("selected").children[0].getAttribute("data-url"));
                    } catch (e) {} // if no card is selected, do nothing
                    break;
                
                case "Escape":
                    document.getElementById("searchbox").value = "";
                    updateResults();
                    break;
            }
        }

        function toTitleCase(str) {
            return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()});
        }

        function updateResults() {
            var query = document.getElementById("searchbox").value;
            var queryLC = query.toLowerCase();
            
            // generate a list of matching results
            var results = [];
            for (var i = keywords.length - 1; i >= 0; i--) { // most specific 
                for (var key in keywords[i]) {
                    if (key.startsWith(queryLC)) {
                        results.push({"keyword": key, "result": keywords[i][key]});
                    }
                }
            }

            // write them out to the DOM
            document.getElementById("results").innerHTML = ""; // clear the old results
            for (var i = 0; i < results.length; i++) {
                document.getElementById("results").appendChild(jsonToCard(results[i]));
            }

            // if there are no results, suggest a Google search
            if (results.length == 0 && query != "") {
                var cardDiv = document.createElement("div");
                var cardBody = document.createElement("div");
                cardDiv.classList.add("card");
                cardBody.classList.add("card-body");
                cardBody.setAttribute("data-url", "https://www.google.co.uk/search?q=" + query);
                cardBody.setAttribute("onclick", "window.location.assign(this.getAttribute('data-url'))");
                cardBody.innerHTML = "No results found. Search for \"" + query + "\" on Google?";
                cardDiv.appendChild(cardBody);
                document.getElementById("results").appendChild(cardDiv);
            }

            // mark the top result as "selected"
            if (query != "") {
                document.getElementById("results").children[0].id = "selected";
            }
        }

        // global keyword array
        var keywords = [];

        // redirect if required
        if (window.location.pathname == "/") {
            window.location.assign(window.location.href + "global");
        } else {
            // focus on the search box
            document.getElementById("searchbox").focus();

            // get the keyword file(s)
            var keywordFiles = window.location.pathname.substr(1).split("/");
            var promises = [];
            for (var i = 0; i < keywordFiles.length; i++) {
                file = "/json/" + keywordFiles[i] + ".json";
                promises.push(
                    fetch(file).then(function(r) {
                        if (!r.ok) {
                            if (r.status == 404) {
                            throw Error("Keyword list " + r.url.split("/").slice(-1)[0] + " not found!");
                            } else {
                                throw Error(r.url.split("/").slice(-1)[0] + ": " + r.status + ": " + r.statusText);
                            }
                        }
                        return r.json()
                    }));
            }
            Promise.all(promises).then(function(jsons) {
                for (var i = 0; i < jsons.length; i++) {
                    keywords.push(jsons[i]);
                }
                updateResults();
            }).catch(function(e) {swal({icon: "error", title:e})});
        }
    </script>
</body>
</html>